module.exports = function servicesMiddleware(factories) {
  const controllers = {}
  const models = {}

  Object.keys(factories.models).forEach(modelName => {
    models[modelName] = factories.models[modelName]({ models })
  })

  Object.keys(factories.controllers).forEach(controllerName => {
    controllers[controllerName] = factories.controllers[controllerName]({ controllers, models })
  })

  const services = {
    controllers,
    models,
  }

  return function $servicesMiddleware(ctx, next) {
    ctx.services = services
    return next()
  }
}
