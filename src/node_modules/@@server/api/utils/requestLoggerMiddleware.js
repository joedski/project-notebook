let uid = 0

module.exports = async function requestLoggerMiddleware(ctx, next) {
  const ruid = uid
  uid += 1
  const startTime = Date.now()
  console.log(`|<<< #${ruid} ${ctx.method} ${ctx.path}`)
  try {
    await next()
    console.log(`|>>> #${ruid} ${ctx.method} ${ctx.path} ${ctx.status}`)
  }
  catch (error) {
    if (error.status) {
      ctx.status = error.status
      ctx.response.body = error.body || { message: error.message }
      console.log(`|>>> #${ruid} ${ctx.method} ${ctx.path} ${ctx.status}`)
      return
    }

    ctx.status = 500
    console.error(error)
    console.warn(`|xxx #${ruid} ${ctx.method} ${ctx.path} ${ctx.status}`)
  }
}
