const path = require('path')

const Koa = require('koa')
const KoaRouter = require('koa-router')
const KoaStatic = require('koa-static')

const requestLoggerMiddleware = require('./utils/requestLoggerMiddleware')
const servicesMiddleware = require('./utils/servicesMiddleware')
const { knex } = require('./utils/knex')

const routers = require('./routers')
const controllers = require('./controllers')
const models = require('./models')

// TODO: koa-helmet
const app = new Koa()

app.use(servicesMiddleware({
  models,
  controllers,
}, {
  knex,
}))

app.use(requestLoggerMiddleware)

const apiRouter = KoaRouter({ prefix: '/api' })
apiRouter.use(routers.pageRouter.routes())

app.use(apiRouter.routes())
app.use(apiRouter.allowedMethods())

const STATIC_PATH = path.resolve('dist')
console.warn('TODO: Parametrize static files path; currently using', STATIC_PATH)
app.use(KoaStatic(STATIC_PATH))

const PORT = process.env.PORT || 8000
app.listen(PORT)
console.log('listening on', PORT)
