const Koa = require('koa')
const KoaRouter = require('koa-router')

const requestLoggerMiddleware = require('./utils/requestLoggerMiddleware')
const servicesMiddleware = require('./utils/servicesMiddleware')
const { knex } = require('./utils/knex')

const routers = require('./routers')
const controllers = require('./controllers')
const models = require('./models')

// TODO: koa-helmet
const app = new Koa()

app.use(servicesMiddleware({
  models,
  controllers,
}, {
  knex,
}))

app.use(requestLoggerMiddleware)

const apiRouter = KoaRouter({ prefix: '/api' })
apiRouter.use(routers.pageRouter.routes())

app.use(apiRouter.routes())
app.use(apiRouter.allowedMethods())

const PORT = process.env.PORT || 8001
app.listen(PORT)
console.log('listening on', PORT)
