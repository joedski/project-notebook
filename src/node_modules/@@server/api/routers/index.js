const KoaRouter = require('koa-router')
const KoaBody = require('koa-body')

const parseBody = (options = {}) => KoaBody({ ...options })
const jsonBody = (options = {}) => parseBody({
  ...options,
  multipart: false,
  urlencoded: false,
  text: false,
})

const pageRouter = KoaRouter()

pageRouter
.get('/pages', async (ctx) => {
  ctx.body = await ctx.services.controllers.Page.getPages()
})
/**
 * Create a page.
 */
.post('/pages', jsonBody(), async (ctx) => {
  // TODO: Schema.
  // TODO: Errors.
  if (!ctx.request.body) ctx.throw(400, 'Malformed or missing body')

  const payload = {
    content: ctx.request.body.content,
    summary: ctx.request.body.summary,
  }

  // "summary" is not required.
  if (!('content' in payload)) ctx.throw(400, 'Missing required prop "content"')

  ctx.body = await ctx.services.controllers.Page.createPage(payload)
})
.get('/pages/:id', async (ctx) => {
  const pageId = parseInt(ctx.params.id, 10)

  if (!ctx.params.id || !Number.isFinite(pageId)) ctx.throw(404)

  try {
    ctx.body = await ctx.services.controllers.Page.getPageById(pageId)
  }
  catch (error) {
    switch (error.appError) {
      case 'entity.not_found': ctx.throw(404)
      default: throw error
    }
  }
})
.put('/pages/:id', jsonBody(), async (ctx) => {
  const pageId = parseInt(ctx.params.id, 10)

  if (!ctx.params.id || !Number.isFinite(pageId)) ctx.throw(404)
  if (!ctx.request.body) ctx.throw(400, 'Malformed or missing body')

  const payload = {
    content: ctx.request.body.content,
    summary: ctx.request.body.summary,
  }

  // "summary" is not required.
  if (!('content' in payload)) ctx.throw(400, 'Missing required prop "content"')

  try {
    ctx.body = await ctx.services.controllers.Page.updatePage(pageId, payload)
  }
  catch (error) {
    switch (error.appError) {
      case 'entity.not_found': ctx.throw(404)
      default: throw error
    }
  }
})

Object.assign(exports, {
  pageRouter,
})
